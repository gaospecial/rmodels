# Basic tidymodels


```{r}
library(tidymodels)
```

::: {.callout-note}
### åœ¨ç»§ç»­ä¹‹å‰ï¼Œä½ åº”è¯¥

-   ä¼šä½¿ç”¨ R è¯­è¨€ä¸­çš„ç®¡é“å‘½ä»¤ `%>%` æˆ–è€… `|>`
-   ç”¨è¿‡è¿™å‡ ä¸ªè½¯ä»¶åŒ…ï¼š`dplyr`, `tidyr`, `ggplot2`
-   äº†è§£åŸºæœ¬çš„ç»Ÿè®¡å­¦æ¦‚å¿µ
-   ç°åœ¨ä¸æ‡‚ï¼Œä½†æ˜¯æƒ³å­¦ä¹ æ¨¡å‹æˆ–è€…æœºå™¨å­¦ä¹ 
:::

åŸºç¡€çš„ tidymodels çŸ¥è¯†åŒ…æ‹¬ä¸‹é¢å‡ ç‚¹ï¼š

- æ•°æ®é¢„å¤„ç†
- æ¨¡å‹çš„ç»“æ„
- æ¨¡å‹çš„è¯„ä»·
- æ¨¡å‹çš„è°ƒä¼˜

::: {#fig-tidymodels-workflow}
```{mermaid}
flowchart LR
 A(å…¨éƒ¨æ•°æ®) --> B1(è®­ç»ƒæ•°æ®é›†)
 A --> B2(æµ‹è¯•æ•°æ®é›†)
 B1 --> F(æœ€ä½³æ¨¡å‹)
 B1 --> C(é‡é‡‡æ ·)
 C --> D1(logistics å›å½’)
 C --> D2[å†³ç­–æ ‘]
 C --> D3[éšæœºæ£®æ—]
 D1 --> E{é€‰æ‹©æ¨¡å‹}
 D2 --> E
 D3 --> E
 E --> F[æœ€ä½³æ¨¡å‹]
 F --> G[éªŒè¯æ¨¡å‹æ€§èƒ½]
 B2 --> G
```
å»ºæ¨¡æµç¨‹å›¾
:::

## å®‰è£…éœ€è¦çš„è½¯ä»¶åŒ…

å®‰è£…ä¸‹é¢çš„è¿™äº›è½¯ä»¶åŒ…ï¼Œä»¥ä¾¿å®Œæˆä¸Šé¢åˆ—ä¸¾çš„ä»»åŠ¡ã€‚

```{r}
#| eval: false
# Install the packages for the workshop
pkgs <- 
  c("bonsai", "doParallel", "embed", "finetune", "lightgbm", "lme4",
    "plumber", "probably", "ranger", "rpart", "rpart.plot", "rules",
    "splines2", "stacks", "text2vec", "textrecipes", "tidymodels", 
    "vetiver", "remotes")

pak::pak(pkgs)
```

## æ•°æ®é¢„å¤„ç†


`modeldata` åŒ…æä¾›äº†ä¸€äº›ç¤ºä¾‹æ•°æ®é›†ï¼Œç”¨äºåœ¨ `tidymodels` ä¸­è¿›è¡Œæ¨¡å‹å»ºè®¾å’Œæ¼”ç¤ºã€‚å…¶ä¸­ "taxi" æ•°æ®é›†æ˜¯ä¸€ä¸ªç®€åŒ–çš„ç¤ºä¾‹æ•°æ®é›†ï¼Œæè¿°äº†èŠåŠ å“¥å‡ºç§Ÿè½¦å¸æœºè·å¾—å°è´¹çš„æƒ…å†µã€‚

å…¶è¯¦ç»†ä¿¡æ¯å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»£ç æŸ¥çœ‹ï¼š

```{r}
library(modeldata)
taxi
```

åŒ…å«çš„å˜é‡æœ‰ï¼š

- `tip`ï¼šä¹˜å®¢æ˜¯å¦ç•™ä¸‹å°è´¹ã€‚ "yes" æˆ– "no"ã€‚
- `distance`ï¼šè¡Œç¨‹è·ç¦»ï¼Œä»¥è‹±é‡Œä¸ºå•ä½ã€‚
- `company`ï¼šå‡ºç§Ÿè½¦å…¬å¸ã€‚å‡ºç°æ¬¡æ•°è¾ƒå°‘çš„å…¬å¸è¢«åˆ†ä¸º "other"ã€‚
- `local`ï¼šè¡Œç¨‹æ˜¯å¦åœ¨åŒä¸€ç¤¾åŒºåŒºåŸŸå¼€å§‹å’Œç»“æŸã€‚
- `dow`ï¼šè¡Œç¨‹å¼€å§‹çš„æ˜ŸæœŸå‡ ã€‚
- `month`ï¼šè¡Œç¨‹å¼€å§‹çš„æœˆä»½ã€‚
- `hour`ï¼šè¡Œç¨‹å¼€å§‹çš„å°æ—¶ã€‚

è¿™ä¸ªæ•°æ®ä¸€å…±æœ‰ 10000 è¡Œã€‚

### æ‹†åˆ†æ•°æ®

åœ¨æœºå™¨å­¦ä¹ ä¸­ï¼Œæ•°æ®é›†ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ç§ç±»å‹ï¼š

1. **è®­ç»ƒé›†ï¼ˆTraining Setï¼‰ï¼š**
   - **å®šä¹‰ï¼š** ç”¨äºè®­ç»ƒæ¨¡å‹çš„æ•°æ®é›†ã€‚
   - **ä½œç”¨ï¼š** æ¨¡å‹é€šè¿‡è®­ç»ƒé›†å­¦ä¹ ç‰¹å¾å’Œæ¨¡å¼ï¼Œè°ƒæ•´å‚æ•°ä»¥æœ€å°åŒ–é¢„æµ‹é”™è¯¯ã€‚

2. **éªŒè¯é›†ï¼ˆValidation Setï¼‰ï¼š**
   - **å®šä¹‰ï¼š** ç”¨äºè°ƒæ•´æ¨¡å‹è¶…å‚æ•°ã€é€‰æ‹©æ¨¡å‹æˆ–é˜²æ­¢è¿‡æ‹Ÿåˆçš„æ•°æ®é›†ã€‚
   - **ä½œç”¨ï¼š** é€šè¿‡åœ¨éªŒè¯é›†ä¸Šè¯„ä¼°æ¨¡å‹æ€§èƒ½ï¼Œè¿›è¡Œè¶…å‚æ•°è°ƒæ•´å’Œæ¨¡å‹é€‰æ‹©ã€‚

3. **æµ‹è¯•é›†ï¼ˆTest Setï¼‰ï¼š**
   - **å®šä¹‰ï¼š** ç”¨äºè¯„ä¼°æ¨¡å‹åœ¨æœªè§è¿‡çš„æ•°æ®ä¸Šçš„æ€§èƒ½çš„æ•°æ®é›†ã€‚
   - **ä½œç”¨ï¼š** æµ‹è¯•é›†æä¾›äº†æ¨¡å‹åœ¨çœŸå®åœºæ™¯ä¸­çš„æ³›åŒ–èƒ½åŠ›çš„ä¼°è®¡ã€‚


ä½¿ç”¨ `initial_split()` å°†æ•°æ®æ‹†åˆ†æˆè®­ç»ƒé›†å’Œæµ‹è¯•é›†ã€‚

```{r taxi-split}
set.seed(123)
library(rsample)

# random split
(taxi_split <- initial_split(taxi))


# access to split data
(taxi_train <- training(taxi_split))
(taxi_test <- testing(taxi_split))
```

ä½¿ç”¨ `initial_validation_split()` å°†æ•°æ®æ‹†åˆ†æˆè®­ç»ƒé›†ã€éªŒè¯é›†å’Œæµ‹è¯•é›†ã€‚

```{r}
set.seed(123)
(taxi_split_2 = initial_validation_split(taxi, prop = c(0.6, 0.2)))

training(taxi_split_2)
testing(taxi_split_2)
validation(taxi_split_2)
```

ä½¿ç”¨å‡½æ•°çš„ `strata`ã€`prop` å‚æ•°ï¼Œä»¥åŠ `initial_time_split()`ã€`group_initial_split()` ç­‰å‡½æ•°ï¼Œå¯ä»¥å®ç°æ›´ç§‘å­¦çš„éšæœºåˆ†ç»„ã€‚

## æ¨¡å‹çš„ç»“æ„


åœ¨ R ä¸­ä½¿ç”¨ `tidymodels` è¿›è¡Œå»ºæ¨¡çš„åŸºæœ¬æ­¥éª¤å¦‚ä¸‹ï¼š

1. **é€‰æ‹©æ¨¡å‹ï¼š**
   - é€‰æ‹©é€‚åˆä»»åŠ¡çš„æ¨¡å‹ï¼Œä¾‹å¦‚çº¿æ€§å›å½’ã€å†³ç­–æ ‘ã€éšæœºæ£®æ—ç­‰ã€‚

2. **æŒ‡å®šå¼•æ“ï¼š**
   - æŒ‡å®šæ¨¡å‹ä½¿ç”¨çš„å¼•æ“ï¼Œå¦‚ "lm" æˆ– "glmnet"ã€‚

3. **è®¾ç½®æ¨¡å‹æ¨¡å¼ï¼š**
   - è®¾ç½®æ¨¡å‹çš„æ¨¡å¼ï¼Œæ˜¯ç”¨äºåˆ†ç±»è¿˜æ˜¯å›å½’ã€‚


::: {.callout-note}
**Models** have default engines.

**Some** models have a default mode.
:::

```{r}
# ä½¿ç”¨é»˜è®¤å¼•æ“çš„é€»è¾‘å›å½’æ¨¡å‹
logistic_reg()

# ä½¿ç”¨ glmnet å¼•æ“çš„é€»è¾‘å›å½’æ¨¡å‹
logistic_reg() %>%
  set_engine("glmnet")

# ä½¿ç”¨ stan å¼•æ“çš„é€»è¾‘å›å½’æ¨¡å‹
logistic_reg() %>%
  set_engine("stan")

# æœªæŒ‡å®šæ¨¡å¼çš„å†³ç­–æ ‘
decision_tree()

# æŒ‡å®šåˆ†ç±»æ¨¡å¼çš„å†³ç­–æ ‘
decision_tree() %>% 
  set_mode("classification")
```

::: {.callout-tip}
All available models are listed at <https://www.tidymodels.org/find/parsnip/> 
:::


## å¼€å§‹å»ºæ¨¡

ä½¿ç”¨ 2 ç§æ¨¡å‹å¯¹ `taxi` æ•°æ®è¿›è¡Œå»ºæ¨¡ã€‚

* Logistic regression
* Decision trees

```{r sim-model-viz}
#| echo: false

set.seed(1)
dat <- sim_logistic(500, ~ .1 + 2 * A)
dat$bin <- cut(dat$A, breaks = c(seq(-3, 3, by = 1/2)), include.lowest = TRUE)
bin_midpoints <- data.frame(A = seq(-3, 3, by = 1/2) + 0.25)

rates <- 
  dat %>% 
  nest(.by = bin) %>% 
  mutate(
    probs = map(data, ~ binom.test(sum(.x$class == "one"), nrow(.x))),
    probs = map(probs, ~ tidy(.x))
  ) %>% 
  select(-data) %>% 
  unnest(cols = probs) %>% 
  arrange(bin) %>% 
  mutate(A = seq(-3, 3, by = 1/2) + 0.25) 

plot_rates <- left_join(rates, bin_midpoints, by = join_by(A)) %>% 
  filter(-2.5 < A, A < 3) %>% 
  ggplot() + 
  geom_point(aes(A, estimate)) +
  geom_errorbar(aes(A, estimate, ymin = conf.low, ymax = conf.high), width = .25)  +
  xlim(c(-3, 3.5)) +
  theme_bw(base_size = 18)
```

### é€»è¾‘å›å½’æ¨¡å‹

é€»è¾‘å›å½’æ¨¡å‹å°†äº‹ä»¶æ¦‚ç‡çš„å¯¹æ•°å‡ ç‡ï¼ˆlogitï¼‰å»ºæ¨¡ä¸ºé¢„æµ‹å˜é‡çš„çº¿æ€§ç»„åˆï¼š

$$
 \log\left(\frac{p}{1 - p}\right) = \beta_0 + \beta_1 \cdot A 
$$

åœ¨è¿™é‡Œï¼š

- $p$ æ˜¯äº‹ä»¶å‘ç”Ÿçš„æ¦‚ç‡ï¼Œ
- $\beta_0$ æ˜¯æˆªè·ï¼Œ
- $\beta_1$ æ˜¯ä¸é¢„æµ‹å˜é‡ $A$ ç›¸å…³çš„ç³»æ•°ã€‚



### å†³ç­–æ ‘

ä½¿ç”¨å†³ç­–æ ‘å»ºæ¨¡ã€‚

- åŸºäºé¢„æµ‹å˜é‡çš„ä¸€ç³»åˆ—åˆ’åˆ†æˆ– if/then è¯­å¥ï¼š

- é¦–å…ˆï¼Œæ ‘ä¼šåœ¨æ»¡è¶³æŸäº›æ¡ä»¶ä¹‹å‰ï¼ˆå¦‚è¾¾åˆ°æœ€å¤§æ·±åº¦æˆ–æ²¡æœ‰æ›´å¤šæ•°æ®æ—¶ï¼‰ä¸æ–­åœ°â€œç”Ÿé•¿â€ï¼ˆgrowï¼‰ã€‚

- ç„¶åï¼Œä¸ºäº†é™ä½æ ‘çš„å¤æ‚æ€§ï¼Œæ ‘ä¼šè¢«â€œä¿®å‰ªâ€ï¼ˆprunedï¼‰ã€‚

```{r}
tree_fit <- decision_tree(mode = "classification") %>% 
  fit(class ~ A, data = mutate(dat, class = forcats::fct_rev(class)))

tree_preds <- augment(tree_fit, new_data = bin_midpoints)

library(rpart.plot)
tree_fit %>%
  extract_fit_engine() %>%
  rpart.plot(roundint = FALSE)
```

å»ºæ¨¡çš„æ•ˆæœå¦‚ä¸‹ï¼š

::: {.callout-caution}
All models are wrong, but some are useful!
:::

```{r}
#| echo: false
#| label: fig-model-comparison
#| fig-cap: é€»è¾‘å›å½’æ¨¡å‹ä¸å†³ç­–æ ‘çš„é¢„æµ‹ç»“æœç¤ºæ„ã€‚ï¼ˆAï¼‰é€šè¿‡é€»è¾‘å‡½æ•°ï¼ˆSå½¢å‡½æ•°ï¼‰ï¼Œæ‰¾åˆ°ä¸€æ¡åˆ†éš”ä¸¤ä¸ªç±»åˆ«çš„æ›²çº¿ã€‚å½“ $p$ å¤§äº 0.5 æ—¶ï¼Œé¢„æµ‹çš„ç±»åˆ«ä¸º 1ï¼›å¦åˆ™ï¼Œä¸º 0ã€‚ S å½¢æ›²çº¿çš„å½¢çŠ¶å®ç°äº†ä¸¤ä¸ªç±»åˆ«ä¹‹é—´çš„å¹³æ»‘è¿‡æ¸¡ã€‚ï¼ˆBï¼‰ä½¿ç”¨å†³ç­–æ ‘å»ºæ¨¡ã€‚

logistic_preds <- logistic_reg() %>% 
  fit(class ~ A, data = dat) %>% 
  augment(new_data = bin_midpoints) 

logistic_model_plot = plot_rates +
  geom_line(aes(A, .pred_one), color = "blue", linewidth = 2, alpha = 0.8, data = logistic_preds)

tree_model_plot = plot_rates +
  geom_step(aes(A, .pred_one), color = "green", linewidth = 2, alpha = 0.8, data = tree_preds)

aplot::plot_list(logistic_model_plot, tree_model_plot, ncol = 2, labels = c("A","B"))
```


### å°†æ¨¡å‹æ•´åˆä¸º workflow

ä½¿ç”¨ `workflow()` æœ‰ä¸€äº›æ˜æ˜¾çš„ä¼˜åŠ¿ï¼ˆ@fig-workflowï¼‰ã€‚

- Workflow åœ¨å¤„ç†æ–°æ•°æ®æ–¹é¢æ¯”åŸºæœ¬çš„ R å·¥å…·æ›´åŠ çµæ´»ï¼Œå°¤å…¶æ˜¯åœ¨æ¶‰åŠæ–°çš„å› å­æ°´å¹³æ—¶ï¼šè¿™åœ¨å¤„ç†åˆ†ç±»å˜é‡æ—¶å°¤ä¸ºé‡è¦ã€‚

- å¯ä»¥ä½¿ç”¨æ›´å¤šçš„æ•°æ®é¢„å¤„ç†å™¨æ¥æå–ç‰¹å¾ï¼ˆåœ¨é«˜çº§ tidymodels ä¸­æ›´å¤šå…³äºç‰¹å¾æå–çš„å†…å®¹ï¼ï¼‰

- ä¾¿äºåŒæ—¶å¤„ç†å¤šä¸ªæ¨¡å‹ã€‚

- æœ€é‡è¦çš„æ˜¯ï¼ŒWorkflow æ¶µç›–äº†æ•´ä¸ªå»ºæ¨¡è¿‡ç¨‹ï¼š`fit()` å’Œ `predict()` ä¸ä»…é€‚ç”¨äºæ¨¡å‹æ‹Ÿåˆï¼Œè¿˜é€‚ç”¨äºé¢„å¤„ç†æ­¥éª¤ã€‚

::: {.callout-note}
### Workflow å¦‚ä½•æ›´å¥½åœ°å¤„ç†å› å­æ°´å¹³

- å¼ºåˆ¶æ‰§è¡Œä¸å…è®¸åœ¨é¢„æµ‹æ—¶å‡ºç°æ–°å› å­æ°´å¹³çš„è§„å®šï¼ˆå¯ä»¥å…³é—­ï¼‰
- æ¢å¤åœ¨æ‹Ÿåˆæ—¶å­˜åœ¨ä½†åœ¨é¢„æµ‹æ—¶ç¼ºå¤±çš„å› å­æ°´å¹³
:::

![Workflows bind preprocessors and models](https://vnote-1251564393.cos.ap-chengdu.myqcloud.com/picgo/202312301710141.png){#fig-workflow}

**ç»å…¸æ–¹æ³•**

```{r tree-spec}
tree_spec <-
  decision_tree(cost_complexity = 0.002) %>% 
  set_mode("classification")

tree_spec %>% 
  fit(tip ~ ., data = taxi_train) 
```

**workflowæ–¹æ³•**

```{r tree-wflow}
tree_spec <-
  decision_tree(cost_complexity = 0.002) %>% 
  set_mode("classification")

# å»ºç«‹ä¸€ä¸ª workflowï¼ŒåŒæ—¶ä¿å­˜æ¨¡å‹å‚æ•°ï¼Œè¡¨è¾¾å¼å’Œæ•°æ®
workflow() %>%
  add_formula(tip ~ .) %>%
  add_model(tree_spec) %>%
  fit(data = taxi_train) 

# æˆ–è€…å†™åœ¨ä¸€èµ·
workflow(tip ~ ., tree_spec) %>% 
  fit(data = taxi_train) 
```

*Edit this code to make a workflow with your own model of choice.*

*Extension/Challenge: Other than formulas, what kinds of preprocessors are supported?*

### ä½¿ç”¨æ¨¡å‹é¢„æµ‹

æ¨èä½¿ç”¨ `augment()` æ–¹æ³•è¿›è¡Œé¢„æµ‹ï¼Œä¸ä¼ ç»Ÿçš„ `predict()` ç›¸æ¯”çš„å·®å¼‚å¦‚ä¸‹ã€‚

```{r}
tree_fit <-
  workflow(tip ~ ., tree_spec) %>% 
  fit(data = taxi_train) 

predict(tree_fit, new_data = taxi_test)

augment(tree_fit, new_data = taxi_test)
```

::: {.callout-note}
- é¢„æµ‹ç»“æœåœ¨ä¸€ä¸ª tibble ä¸­ï¼›
- åˆ—åå’Œæ•°æ®ç±»å‹æ›´åŠ æ¸…æ™°å’Œæ˜“äºç†è§£ï¼›
- è¡Œæ•°å’Œè¾“å‡ºç»“æœçš„è¡Œæ•°æ˜¯ç›¸åŒçš„ï¼Œç¡®ä¿äº†æ•°æ®çš„å¯¹åº”å…³ç³»ã€‚
:::

### è§£é‡Šæ¨¡å‹

ä½¿ç”¨ `extract_*()` å‡½æ•°æå–æ¨¡å‹ workflow å¯¹è±¡çš„ç»„ä»¶ã€‚å¦‚ @fig-plot-tree-fit å±•ç¤ºäº†ä¸Šé¢å†³ç­–æ ‘æ¨¡å‹çš„åˆ†ç±»è¿‡ç¨‹ã€‚

```{r}
#| label: fig-plot-tree-fit
#| fig-cap: å†³ç­–æ ‘çš„å†³ç­–è¿‡ç¨‹
library(rpart.plot)
tree_fit %>%
  extract_fit_engine() %>%
  rpart.plot(roundint = FALSE)
```


You can use your fitted workflow for model and/or prediction explanations:

-   overall variable importance, such as with the [vip](https://koalaverse.github.io/vip/) package

-   flexible model explainers, such as with the [DALEXtra](https://dalex.drwhy.ai/) package


## æ¨¡å‹çš„è¯„ä»·

### æ¨¡å‹

```{r setup-previous}
#| echo: false
library(tidymodels)

set.seed(123)
taxi_split <- initial_split(taxi, prop = 0.8, strata = tip)
taxi_train <- training(taxi_split)
taxi_test <- testing(taxi_split)

tree_spec <- decision_tree(cost_complexity = 0.0001, mode = "classification")
taxi_wflow <- workflow(tip ~ ., tree_spec)
taxi_fit <- fit(taxi_wflow, taxi_train)
```

### æ··æ·†çŸ©é˜µ

æ··æ·†çŸ©é˜µå°†çœŸå®å€¼å’Œé¢„æµ‹å€¼ä»¥çƒ­å›¾çš„å½¢æˆå‘ˆç°å‡ºæ¥ã€‚

```{r conf-mat-plot}
#| label: fig-conf-mat-plot
#| fig-asp: 0.5
#| fig-cap: æ··æ·†çŸ©é˜µ
library(ggplot2)
library(forcats)
p1 = augment(taxi_fit, new_data = taxi_train) %>%
  conf_mat(truth = tip, estimate = .pred_class) %>%
  autoplot(type = "heatmap") +
  coord_equal()

# é˜³æ€§ä¸é˜´æ€§
df = tibble(Truth = as_factor(c("yes","yes","no","no")),
Prediction = as_factor(c("no","yes","no","yes")),
label = c("FN","TP","TN","FP"))
p2 = ggplot(df, aes(Truth, Prediction, label = label)) +
geom_tile(fill = "grey90", color = "grey", linewidth = 1) +
geom_text() +
coord_equal() +
theme_minimal()

aplot::plot_list(p1, p2, labels = c("A","B"))
```

```{r}
#| echo: false
TP = 7341
FP = 536
FN = 43
TN = 80
```

### å‡†ç¡®æ€§

æ ¹æ® @eq-predict-accuracy å¯ä»¥è®¡ç®—å‡†ç¡®æ€§ä¸º `r (TP+TN)/(TP+TN+FP+FN)`ã€‚

$$
accuracy = \frac{TP + TN}{TP+FP+TN+FN}
$$ {#eq-predict-accuracy}

```{r acc}
augment(taxi_fit, new_data = taxi_train) %>%
  accuracy(truth = tip, estimate = .pred_class)
```

### æ•æ„Ÿæ€§

æ ¹æ® @eq-predict-sensitivity å¯ä»¥è®¡ç®—å…¶æ•°å€¼ä¸º `r (TP)/(TP+FN)`ã€‚


$$
sensitivity = \frac{TP}{TP+FP}
$$ {#eq-predict-sensitivity}


```{r sens}
augment(taxi_fit, new_data = taxi_train) %>%
  sensitivity(truth = tip, estimate = .pred_class)
```

### ç‰¹å¼‚æ€§

æ ¹æ® @eq-predict-specificity å¯ä»¥è®¡ç®—å…¶æ•°å€¼ä¸º `r (TN)/(TN+FP)`ã€‚


$$
sensitivity = \frac{TP}{TP+FP}
$$ {#eq-predict-specificity}


```{r spec}
augment(taxi_fit, new_data = taxi_train) %>%
  specificity(truth = tip, estimate = .pred_class)
```

::: {.callout-note}

- **æ•æ„Ÿæ€§**å‘Šè¯‰æˆ‘ä»¬ï¼Œæµ‹è¯•æœ‰å¤šå¤§ç¨‹åº¦ä¸Šèƒ½å¤Ÿæ•æ‰åˆ°çœŸæ­£çš„é˜³æ€§å®ä¾‹ï¼Œå³å¯¹äºå®é™…ä¸ºé˜³æ€§çš„æ ·æœ¬ï¼Œæµ‹è¯•æœ‰å¤šå¤§å¯èƒ½æ€§èƒ½å¤Ÿæ­£ç¡®åœ°è¯†åˆ«å‡ºå®ƒä»¬ã€‚
- **ç‰¹å¼‚æ€§**å‘Šè¯‰æˆ‘ä»¬ï¼Œæµ‹è¯•æœ‰å¤šå¤§ç¨‹åº¦ä¸Šèƒ½å¤Ÿæ­£ç¡®åœ°æ’é™¤å®é™…ä¸ºé˜´æ€§çš„æ ·æœ¬ï¼Œå³å¯¹äºå®é™…ä¸ºé˜´æ€§çš„æ ·æœ¬ï¼Œæµ‹è¯•æœ‰å¤šå¤§å¯èƒ½æ€§èƒ½å¤Ÿæ­£ç¡®åœ°å°†å®ƒä»¬è¯†åˆ«ä¸ºé˜´æ€§ã€‚
- **å‡†ç¡®ç‡**æ˜¯ä¸€ä¸ªç»¼åˆæ€§æŒ‡æ ‡ï¼Œè¡¡é‡äº†åˆ†ç±»æ¨¡å‹å¯¹äºæ‰€æœ‰æ ·æœ¬çš„æ•´ä½“é¢„æµ‹å‡†ç¡®æ€§ã€‚å…·ä½“è€Œè¨€ï¼Œå®ƒè¡¨ç¤ºæ¨¡å‹æ­£ç¡®é¢„æµ‹çš„æ ·æœ¬åœ¨æ‰€æœ‰æ ·æœ¬ä¸­çš„æ¯”ä¾‹ã€‚

:::

ä½¿ç”¨ `metric_set()` å¯ä»¥ä¸€æ¬¡è·å–å¤šä¸ªæŒ‡æ ‡ï¼ˆå¦è§ @fig-thresholdsï¼‰ã€‚

```{r taxi-metrics}
taxi_metrics <- metric_set(accuracy, specificity, sensitivity)

augment(taxi_fit, new_data = taxi_train) %>%
  taxi_metrics(truth = tip, estimate = .pred_class)
```



```{r}
#| label: fig-thresholds
#| echo: false
#| fig-cap: æ•æ„Ÿæ€§å’Œç‰¹å¼‚æ€§é€šå¸¸æ˜¯ä¸€å¯¹çŸ›ç›¾çš„æŒ‡æ ‡ï¼Œå³æé«˜æ•æ„Ÿæ€§å¯èƒ½ä¼šé™ä½ç‰¹å¼‚æ€§ï¼Œåä¹‹äº¦ç„¶ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œé€‰æ‹©å“ªä¸ªæŒ‡æ ‡æ›´é‡è¦å–å†³äºå…·ä½“çš„é—®é¢˜å’Œåº”ç”¨èƒŒæ™¯ã€‚

augment(taxi_fit, new_data = taxi_train) %>% 
  roc_curve(truth = tip, .pred_yes) %>% 
  filter(is.finite(.threshold)) %>% 
  pivot_longer(c(specificity, sensitivity), names_to = "statistic", values_to = "value") %>% 
  rename(`event threshold` = .threshold) %>% 
  ggplot(aes(x = `event threshold`, y = value, col = statistic, group = statistic)) + 
  geom_line() +
  scale_color_brewer(palette = "Dark2") +
  labs(y = NULL) +
  coord_equal() +
  theme_bw() +
  theme(legend.position = "top")
```

### ROC æ›²çº¿

ROCï¼ˆReceiver Operating Characteristicï¼‰æ›²çº¿æ˜¯ä¸€ç§ç”¨äºè¯„ä¼°äºŒåˆ†ç±»æ¨¡å‹æ€§èƒ½çš„å›¾å½¢å·¥å…·ã€‚ä»¥ä¸‹æ˜¯å…³äºROCæ›²çº¿çš„å®šä¹‰å’Œè§£é‡Šï¼š

1. **å®šä¹‰**ï¼š

   - ROCæ›²çº¿æ˜¯ä¸€ç§ä»¥å‡æ­£ä¾‹ç‡ï¼ˆFalse Positive Rateï¼ŒFPRï¼‰ä¸ºæ¨ªè½´ã€çœŸæ­£ä¾‹ç‡ï¼ˆTrue Positive Rateï¼ŒTPRæˆ–æ•æ„Ÿæ€§ï¼‰ä¸ºçºµè½´çš„å›¾å½¢ã€‚å®ƒæ˜¾ç¤ºäº†åœ¨ä¸åŒé˜ˆå€¼ä¸‹ï¼Œæ¨¡å‹çš„çœŸæ­£ä¾‹ç‡å’Œå‡æ­£ä¾‹ç‡ä¹‹é—´çš„æƒè¡¡å…³ç³»ã€‚

2. **ç»˜åˆ¶æ–¹å¼**ï¼š

   - åœ¨ROCæ›²çº¿ä¸­ï¼Œæ¨ªè½´è¡¨ç¤ºFPRï¼Œçºµè½´è¡¨ç¤ºTPRã€‚æ¨¡å‹çš„è¾“å‡ºæ¦‚ç‡æˆ–åˆ†æ•°è¢«ç”¨ä½œä¸åŒé˜ˆå€¼ï¼Œä»è€Œç”Ÿæˆä¸€ç³»åˆ—çš„TPRå’ŒFPRå€¼ã€‚

3. **è§£é‡Š**ï¼š

   - ROCæ›²çº¿èƒ½å¤Ÿå±•ç¤ºåœ¨ä¸åŒåˆ†ç±»é˜ˆå€¼ä¸‹ï¼Œæ¨¡å‹åœ¨è¯†åˆ«æ­£ä¾‹ï¼ˆé˜³æ€§ç±»åˆ«ï¼‰å’Œè´Ÿä¾‹ï¼ˆé˜´æ€§ç±»åˆ«ï¼‰æ–¹é¢çš„æ€§èƒ½ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼ŒROCæ›²çº¿è¶Šé è¿‘å·¦ä¸Šè§’ï¼Œæ¨¡å‹æ€§èƒ½è¶Šå¥½ï¼Œå› ä¸ºåœ¨é‚£é‡Œï¼ŒTPRè¾ƒé«˜è€ŒFPRè¾ƒä½ã€‚

4. **AUCå€¼**ï¼š

   - ROCæ›²çº¿ä¸‹çš„é¢ç§¯ï¼ˆArea Under the Curveï¼ŒAUCï¼‰ä¹Ÿæ˜¯ä¸€ä¸ªå¸¸ç”¨çš„æ€§èƒ½åº¦é‡ã€‚AUCå€¼è¶Šæ¥è¿‘1ï¼Œè¡¨ç¤ºæ¨¡å‹æ€§èƒ½è¶Šå¥½ã€‚AUCå€¼ä¸º0.5æ—¶ï¼Œè¡¨ç¤ºæ¨¡å‹çš„æ€§èƒ½ç­‰åŒäºéšæœºçŒœæµ‹ã€‚

5. **ç¤ºä¾‹**ï¼š

   - ä¸€ä¸ªç†æƒ³çš„ROCæ›²çº¿ä¼šæ²¿ç€å·¦ä¸Šè§’çš„è¾¹ç¼˜ï¼Œæœ€ç»ˆè¾¾åˆ°ï¼ˆ0, 1ï¼‰ç‚¹ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒROCæ›²çº¿åœ¨å›¾å½¢ä¸Šæ˜¯å‘å·¦ä¸Šå‡¸èµ·çš„ã€‚

åœ¨å®é™…åº”ç”¨ä¸­ï¼ŒROCæ›²çº¿å’ŒAUCå€¼æ˜¯è¯„ä¼°åˆ†ç±»æ¨¡å‹æ€§èƒ½çš„é‡è¦å·¥å…·ï¼Œå°¤å…¶åœ¨å¤„ç†ä¸åŒç±»åˆ«åˆ†å¸ƒå’Œä¸åŒé˜ˆå€¼çš„æƒ…å†µä¸‹ã€‚

given that sensitivity is the true positive rate, and specificity is the true negative rate. Hence `1 - specificity` is the false positive rate.

We can use the area under the ROC curve as a classification metric: 

- ROC AUC = 1 ğŸ’¯ 
- ROC AUC = 1/2 ğŸ˜¢

```{r roc-auc}
# Assumes _first_ factor level is event; there are options to change that
augment(taxi_fit, new_data = taxi_train) %>% 
  roc_curve(truth = tip, .pred_yes) %>%
  slice(1, 20, 50)

augment(taxi_fit, new_data = taxi_train) %>% 
  roc_auc(truth = tip, .pred_yes)
```

@fig-taxi-fit-roc-curve æ˜¾ç¤ºäº†ä¸Šé¢è¿™ä¸ªæ¨¡å‹çš„ ROC æ›²çº¿ã€‚

```{r fig-taxi-fit-roc-curve}
#| label: fig-taxi-fit-roc-curve
#| fig-cap: è¿™ä¸ªæ¨¡å‹çš„ ROC AUC å€¼ä¸º 0.691ã€‚
augment(taxi_fit, new_data = taxi_train) %>% 
  roc_curve(truth = tip, .pred_yes) %>%
  autoplot()
```


### è¿‡æ‹Ÿåˆ

å°†è®­ç»ƒå¾—åˆ°çš„æ¨¡å‹åˆ†åˆ«ç”¨äºè®­ç»ƒæ•°æ®é›†å’Œæµ‹è¯•æ•°æ®é›†ï¼Œæ¯”è¾ƒäºŒè€…é¢„æµ‹çš„å‡†ç¡®ç‡ï¼Œå¯ä»¥å‘ç°é¢„æµ‹è®­ç»ƒæ•°æ®é›†çš„ç»“æœä¼˜äºæµ‹è¯•æ•°æ®é›†ã€‚è¿™å°±æ˜¯æ¨¡å‹çš„è¿‡æ‹Ÿåˆç°è±¡ï¼ˆ@fig-over-fittingï¼‰ã€‚

![è¿‡æ‹Ÿåˆ](https://raw.githubusercontent.com/topepo/2022-nyr-workshop/main/images/tuning-overfitting-test-1.svg){#fig-over-fitting}

é¦–å…ˆï¼Œæ¯”è¾ƒä¸€ä¸‹æ¨¡å‹çš„å‡†ç¡®æ€§æŒ‡æ ‡ã€‚

```{r}
# æ¨¡å‹é¢„æµ‹è®­ç»ƒæ•°æ®é›†
taxi_fit %>%
  augment(taxi_train) %>%
  accuracy(tip, .pred_class)

# æ¨¡å‹é¢„æµ‹æµ‹è¯•æ•°æ®é›†
taxi_fit %>%
  augment(taxi_test) %>%
  accuracy(tip, .pred_class)
```

å…¶æ¬¡ï¼Œæ¯”è¾ƒä¸€ä¸‹ Brier åˆ†æ•°ã€‚

```{r brier-class}
taxi_fit %>%
  augment(taxi_train) %>%
  brier_class(tip, .pred_yes)

taxi_fit %>%
  augment(taxi_test) %>%
  brier_class(tip, .pred_yes)
```

Brieråˆ†æ•°ï¼ˆBrier Scoreï¼‰æ˜¯ä¸€ç§ç”¨äºè¯„ä¼°åˆ†ç±»æ¨¡å‹æ€§èƒ½çš„æŒ‡æ ‡ã€‚å¯¹äºäºŒåˆ†ç±»é—®é¢˜ï¼ŒBrieråˆ†æ•°çš„è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š

$$
Brier\ Score = \frac{1}{N} \sum_{i=1}^{N} (f_i - o_i)^2
$$

å…¶ä¸­ï¼š
- $N$ æ˜¯æ ·æœ¬æ•°ï¼›
- $f_i$ æ˜¯æ¨¡å‹å¯¹äº‹ä»¶å‘ç”Ÿçš„æ¦‚ç‡çš„é¢„æµ‹å€¼ï¼›
- $o_i$ æ˜¯å®é™…è§‚æµ‹åˆ°çš„äºŒåˆ†ç±»ç»“æœï¼Œå–å€¼ä¸º0æˆ–1ï¼ˆä¾‹å¦‚ï¼Œäº‹ä»¶æœªå‘ç”Ÿä¸º0ï¼Œäº‹ä»¶å‘ç”Ÿä¸º1ï¼‰ã€‚

Brieråˆ†æ•°çš„å–å€¼èŒƒå›´åœ¨0åˆ°1ä¹‹é—´ï¼Œ0è¡¨ç¤ºå®Œç¾é¢„æµ‹ï¼Œ1è¡¨ç¤ºæœ€å·®çš„é¢„æµ‹ã€‚è¾ƒä½çš„Brieråˆ†æ•°è¡¨ç¤ºæ¨¡å‹å¯¹è§‚æµ‹ç»“æœçš„æ¦‚ç‡é¢„æµ‹æ›´å‡†ç¡®ã€‚æ‰€ä»¥ï¼Œä»ç„¶å¯ä»¥å‘ç°æ¨¡å‹è¿‡æ‹Ÿåˆçš„ç°è±¡ã€‚

### äº¤å‰éªŒè¯

åœ¨ä¸ä½¿ç”¨æµ‹è¯•æ•°æ®é›†çš„å‰æä¸‹ï¼Œèƒ½ä¸èƒ½æ¯”è¾ƒæ¨¡å‹çš„å‚æ•°ï¼Ÿè¿™å°±è¦ç”¨åˆ°äº¤å‰éªŒè¯ã€‚`vfold_cv()` å‡½æ•°é»˜è®¤å°†è®­ç»ƒæ•°æ®é›†ä¸­çš„ååˆ†ä¹‹ä¸€ï¼ˆ`v = 10`ï¼‰å–å‡ºæ¥ï¼Œç”¨äºè®¡ç®—ã€æ¯”è¾ƒæ¨¡å‹çš„æ€§èƒ½å‚æ•°ã€‚

```{r taxi-folds}
set.seed(123)
taxi_folds <- vfold_cv(taxi_train, v = 10, strata = tip)
taxi_folds
```

ä½¿ç”¨ `fit_resamples()` å‡½æ•°æ¥å¯¹å¤šæ¬¡å–æ ·çš„æ•°æ®è¿›è¡Œæ‹Ÿåˆï¼Œä½¿ç”¨ `collect_mertics()` è¯„ä»·æ¨¡å‹çš„æ€§èƒ½ã€‚

```{r fit-resamples}
taxi_res <- fit_resamples(taxi_wflow, taxi_folds)
taxi_res
```

```{r collect-metrics}
taxi_res %>%
  collect_metrics()
```

::: {.callout-note}
`collect_metrics()` is one of a suite of `collect_*()` functions that can be used to work with columns of tuning results. Most columns in a tuning result prefixed with `.` have a corresponding `collect_*()` function with options for common summaries.
:::

äº¤å‰éªŒè¯é€šè¿‡é‡é‡‡æ ·å’Œæ€§èƒ½æ¯”è¾ƒï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥åœ¨ä»…ä½¿ç”¨è®­ç»ƒé›†å°±å¯ä»¥å¯é åœ°æ¯”è¾ƒæ¨¡å‹çš„æ€§èƒ½ã€‚

::: {.callout-warning}
è®°ä½ï¼š

- è®­ç»ƒé›†ä¼šç»™å‡ºè¿‡äºä¹è§‚çš„æŒ‡æ ‡
- æµ‹è¯•é›†éå¸¸å®è´µ
:::


```{r save-predictions}
# Save the assessment set results
ctrl_taxi <- control_resamples(save_pred = TRUE)
taxi_res <- fit_resamples(taxi_wflow, taxi_folds, control = ctrl_taxi)

taxi_res

# Save the assessment set results
taxi_preds <- collect_predictions(taxi_res)
taxi_preds

# Evaluating model performance
taxi_preds %>% 
  group_by(id) %>%
  taxi_metrics(truth = tip, estimate = .pred_class)

taxi_res
```

äº¤å‰éªŒè¯çš„è’™ç‰¹å¡æ´›æ–¹æ³•ï¼Œä»¥åŠåˆ›å»ºéªŒè¯æ•°æ®é›†ã€‚

```{r mc-cv}
set.seed(322)
# use the Monte Carlo Cross-Validation
mc_cv(taxi_train, times = 10)

# create validation set
taxi_val_split <- initial_validation_split(taxi, strata = tip)
validation_set(taxi_val_split)
```


## æ¨¡å‹çš„è°ƒä¼˜